- hosts: localhost

  tasks:
    - set_fact:
        home_dir: "{{ lookup('env', 'HOME') }}"
  
    - name: Update packages
      become: yes
      ansible.builtin.apt:
        update_cache: "yes"
        upgrade: "yes"
        state: latest

    - name: Install packages
      become: yes
      ansible.builtin.apt:
        name:
          - bat
          - zsh
          - vim
          - curl
          - 7zip
          - cmake
          - build-essential
          - ncdu
          - iputils-ping
          - openssl
          - libssl-dev
          - pkg-config
          - libwebkit2gtk-4.1-dev
          - wget
          - file
          - libxdo-dev
          - libayatana-appindicator3-dev
          - librsvg2-dev
          - unzip

    - name: Allow the current user to sudo without a password
      become: yes
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        line: "{{ ansible_user_id }} ALL=(ALL) NOPASSWD:ALL"

    - name: Create the .config folder if it does not exist
      ansible.builtin.file:
        path: "{{home_dir}}/.config"
        state: directory
        mode: '755'
      args:
        creates: "{{home_dir}}/.config"
        
    - name: Create the .local/bin folder if it does not exist
      ansible.builtin.file:
        path: "{{home_dir}}/.local/bin"
        state: directory
        mode: '755'
      args:
        creates: "{{home_dir}}/.local/bin"
        
    - name: git clone zsh autocomplete
      ansible.builtin.git:
        repo: https://github.com/marlonrichert/zsh-autocomplete.git
        dest: "{{home_dir}}/packages/zsh-autocomplete"
        version: 25.03.19
      args:
        creates: "{{home_dir}}/packages/zsh-autocomplete"

    - name: Create a symbolic link to the .zshrc file
      ansible.builtin.file:
        src: "{{ playbook_dir }}/.zshrc"
        dest: "{{ home_dir }}/.zshrc"
        state: link
        force: true

    - name: Make zsh the default shell
      user: "name={{ ansible_user_id }} shell=/usr/bin/zsh"
      become: yes

    - name: git clone nvm
      ansible.builtin.git:
        repo: https://github.com/nvm-sh/nvm.git
        dest: "{{home_dir}}/.nvm"
        version: v0.40.3
      args:
        creates: "{{home_dir}}/.nvm"

    - name: Download the rust installation script
      ansible.builtin.get_url:
        url: https://sh.rustup.rs
        dest: "{{home_dir}}/packages/sh.rustup.rs"
        mode: "0750"
        force: true
      args:
        creates: "{{home_dir}}/packages/sh.rustup.rs"

    - name: Install rust
      ansible.builtin.shell: "{{home_dir}}/packages/sh.rustup.rs -y"

    - name: Install bun
      ansible.builtin.shell: "curl -fsSL https://bun.sh/install | bash"
      args:
        creates: "{{home_dir}}/.bun/bin/bun"

    - name: Install bun completions
      ansible.builtin.shell: "{{home_dir}}/.bun/bin/bun completions zsh"
      args:
        creates: "{{home_dir}}/.bun/_bun"
